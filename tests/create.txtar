# this testscript test the 'create' command

# if go is not installed, then skip
[!exec:go] skip

exec fwdctl create --help
stdout 'Usage:'

# test primarly subcommand 'create'
exec fwdctl create -d 3000 -s 127.0.0.1 -p 80 -i lo
fwd_exists lo tcp 3000 127.0.0.1 80

# test alternative name 'add'
exec fwdctl add -d 3001 -s 127.0.0.1 -p 80 -i lo
fwd_exists lo tcp 3001 127.0.0.1 80

# test creation of udp rule
exec fwdctl create -d 3002 -s 127.0.0.1 -p 80 -i lo -P udp
fwd_exists lo udp 3002 127.0.0.1 80

exec fwdctl list -o json
cmp stdout fwdctl_list.json

# clean up environment
exec fwdctl delete -n 1
exec fwdctl delete -n 1
exec fwdctl delete -n 1

# create rule without specifying interface
exec fwdctl create -d 3003 -s 127.0.0.1 -p 80
fwd_exists lo tcp 3003 127.0.0.1 80
exec fwdctl delete -n 1

# should not create rules
! exec fwdctl create -d 3003 -s 127.0.0.1
! exec fwdctl create -d 3003 -p 80
! exec fwdctl create -s 127.0.0.1 -p 80
! exec fwdctl create -i lo -P tcp

-- fwdctl_list.json --
{
    "02277b77be4aec43a6e91433e2fc1fb0": {
        "Iface": "lo",
        "Proto": "udp",
        "Dport": 3002,
        "Saddr": "127.0.0.1",
        "Sport": 80,
        "Comment": ""
    },
    "0be1c5f4141015ca6a8e873344da06e6": {
        "Iface": "lo",
        "Proto": "tcp",
        "Dport": 3000,
        "Saddr": "127.0.0.1",
        "Sport": 80,
        "Comment": ""
    },
    "73d008929b591e12220cef0bb9a2710e": {
        "Iface": "lo",
        "Proto": "tcp",
        "Dport": 3001,
        "Saddr": "127.0.0.1",
        "Sport": 80,
        "Comment": ""
    }
}
